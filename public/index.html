<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Timeline Visits Map</title>

  <!-- MapLibre GL JS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css"
  />

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body, html {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
    }

    #map {
      height: 100vh;
      width: 100%;
    }

    /* ìƒë‹¨ ì»¨íŠ¸ë¡¤ */
    #controls {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: white;
      padding: 20px 24px;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      width: 90%;
      max-width: 800px;
      backdrop-filter: blur(10px);
    }

    #dateLabel {
      font-weight: 700;
      font-size: 18px;
      margin-bottom: 8px;
      text-align: center;
      color: #333;
    }

    #locationLabel {
      font-size: 15px;
      color: #667eea;
      margin-bottom: 12px;
      text-align: center;
      font-weight: 600;
    }

    #timeline {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: #e9ecef;
      outline: none;
      -webkit-appearance: none;
      margin-bottom: 12px;
      pointer-events: none;
      cursor: default;
      opacity: 0.7;
    }

    #timeline::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      -moz-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      cursor: default;
      box-shadow: 0 2px 6px rgba(102, 126, 234, 0.4);
      transition: all 0.3s ease;
      pointer-events: none;
    }

    #timeline::-webkit-slider-thumb:hover {
      transform: none;
      box-shadow: 0 2px 6px rgba(102, 126, 234, 0.4);
    }

    #timeline::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      cursor: default;
      border: none;
      box-shadow: 0 2px 6px rgba(102, 126, 234, 0.4);
      transition: all 0.3s ease;
      pointer-events: none;
    }

    #timeline::-moz-range-thumb:hover {
      transform: none;
      box-shadow: 0 2px 6px rgba(102, 126, 234, 0.4);
    }

    #buttons {
      margin-top: 8px;
      text-align: center;
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    button {
      padding: 10px 20px;
      margin: 0;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      font-family: inherit;
    }

    #playBtn, #restartBtn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    #playBtn:hover, #restartBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }

    #pauseBtn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    #pauseBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }

    #speedBtn {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
    }

    #speedBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4);
    }

    #speedBtn.active {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    .legend {
      background: rgba(255, 255, 255, 0.98);
      padding: 14px 16px;
      font-size: 13px;
      line-height: 1.8;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      backdrop-filter: blur(10px);
    }

    .mapboxgl-popup-content {
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      padding: 16px;
    }

    .mapboxgl-popup-close-button {
      font-size: 20px;
      padding: 4px 8px;
    }

    /* í´ëŸ¬ìŠ¤í„° ë§ˆì»¤ ìŠ¤íƒ€ì¼ */
    .cluster-marker {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 50%;
      color: white;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 3px solid white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .cluster-marker:hover {
      transform: scale(1.15);
      box-shadow: 0 6px 16px rgba(0,0,0,0.4);
    }

    /* ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ìŠ¤íƒ€ì¼ */
    .cluster-dropdown {
      position: absolute;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
      max-height: 400px;
      overflow-y: auto;
      z-index: 2000;
      min-width: 300px;
      max-width: 500px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      display: none;
    }

    .cluster-dropdown.show {
      display: block;
    }

    .cluster-dropdown-header {
      padding: 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 12px 12px 0 0;
      font-weight: 700;
      font-size: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .cluster-dropdown-close {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .cluster-dropdown-close:hover {
      background: rgba(255,255,255,0.3);
    }

    .cluster-dropdown-item {
      padding: 12px 16px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .cluster-dropdown-item:hover {
      background: #f8f9fa;
    }

    .cluster-dropdown-item:last-child {
      border-bottom: none;
    }

    .cluster-item-type {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .cluster-item-time {
      font-size: 12px;
      color: #666;
      margin-bottom: 2px;
    }

    .cluster-item-duration {
      font-size: 11px;
      color: #999;
    }
  </style>
</head>
<body>

<div id="controls">
  <div id="dateLabel">ë‚ ì§œ</div>
  <div id="locationLabel">ì§€ì—­ëª…</div>
  <input id="timeline" type="range" min="0" max="0" value="0" step="1" disabled />
  <div id="buttons">
    <button id="playBtn">â–¶ ì¬ìƒ</button>
    <button id="pauseBtn" style="display:none;">â¸ ì •ì§€</button>
    <button id="restartBtn">â® ë‹¤ì‹œ ì¬ìƒ</button>
    <button id="speedBtn">â© 1x</button>
    <button id="downloadBtn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">ğŸ’¾ ë‹¤ìš´ë¡œë“œ</button>
  </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
<script>
// ë©”ëª¨ë¦¬ íš¨ìœ¨ì ì¸ ë°ì´í„° ë¡œë”©
async function loadVisitsData() {
  try {
    // ì¸ë¼ì¸ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš© (ë¡œì»¬ ì‹¤í–‰ìš© - CORS ë¬¸ì œ í•´ê²°)
    if (window.VISITS_DATA) {
      console.log('ì¸ë¼ì¸ ë°ì´í„° ì‚¬ìš© (ë¡œì»¬ ì‹¤í–‰ ëª¨ë“œ)');
      const data = window.VISITS_DATA;
      console.log(`ë¡œë“œëœ ë°ì´í„°: ${data.length}ê°œ í•­ëª©`);

      /* 1ï¸âƒ£ visit ë°ì´í„°ë§Œ ì¶”ì¶œ (ì´ë¯¸ ì„œë²„ì—ì„œ ìµœì í™”ë¨) */
      const visits = data.filter(d =>
        d.placeLocation && d.startTime && d.endTime
      );

      console.log(`ìœ íš¨í•œ ë°©ë¬¸ ë°ì´í„°: ${visits.length}ê°œ`);

      /* 2ï¸âƒ£ í¬ì¸íŠ¸ ë³€í™˜ (ë©”ëª¨ë¦¬ íš¨ìœ¨ì ìœ¼ë¡œ) */
      const points = [];
      for (let i = 0; i < visits.length; i++) {
        const d = visits[i];
        try {
          const [lat, lng] = d.placeLocation
            .replace('geo:', '')
            .split(',')
            .map(Number);

          if (isNaN(lat) || isNaN(lng)) continue;

          const start = new Date(d.startTime);
          const end = new Date(d.endTime);
          const durationHours = (end - start) / 1000 / 60 / 60;

          points.push({
            lat,
            lng,
            start,
            end,
            durationHours,
            type: d.semanticType || 'Unknown'
          });
        } catch (e) {
          console.warn(`ë°ì´í„° ë³€í™˜ ì‹¤íŒ¨ (ì¸ë±ìŠ¤ ${i}):`, e);
        }

        // ë©”ëª¨ë¦¬ ê´€ë¦¬ë¥¼ ìœ„í•œ ì£¼ê¸°ì  íŒíŠ¸
        if (i % 5000 === 0 && i > 0) {
          console.log(`í¬ì¸íŠ¸ ë³€í™˜ ì¤‘... ${i}/${visits.length} (${((i/visits.length)*100).toFixed(1)}%)`);
        }
      }

      console.log(`ë³€í™˜ëœ í¬ì¸íŠ¸: ${points.length}ê°œ`);
      
      // ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í™•ì¸ (ê°€ëŠ¥í•œ ê²½ìš°)
      if (performance.memory) {
        const memoryMB = (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(2);
        console.log(`í˜„ì¬ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: ${memoryMB} MB`);
      }
      
      return points;
    }
    
    // ì„œë²„ì—ì„œ ë°ì´í„° ë¡œë“œ (ì›¹ ì„œë²„ì—ì„œ ì‹¤í–‰ ì‹œ)
    console.log('ë°ì´í„° ë¡œë”© ì‹œì‘...');
    const response = await fetch('visits.json');
    
    if (!response.ok) {
      throw new Error('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    // ìŠ¤íŠ¸ë¦¬ë°ìœ¼ë¡œ JSON íŒŒì‹± (ëŒ€ìš©ëŸ‰ íŒŒì¼ ì²˜ë¦¬)
    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let jsonText = '';
    let chunkCount = 0;

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      
      jsonText += decoder.decode(value, { stream: true });
      chunkCount++;
      
      // ì§„í–‰ ìƒí™© í‘œì‹œ (í° íŒŒì¼ì˜ ê²½ìš°)
      if (chunkCount % 100 === 0) {
        console.log(`ë°ì´í„° ë¡œë”© ì¤‘... (${chunkCount} ì²­í¬)`);
      }
    }

    console.log('JSON íŒŒì‹± ì‹œì‘...');
    const data = JSON.parse(jsonText);
    jsonText = null; // ë©”ëª¨ë¦¬ í•´ì œ

    console.log(`ë¡œë“œëœ ë°ì´í„°: ${data.length}ê°œ í•­ëª©`);

    /* 1ï¸âƒ£ visit ë°ì´í„°ë§Œ ì¶”ì¶œ (ì´ë¯¸ ì„œë²„ì—ì„œ ìµœì í™”ë¨) */
    const visits = data.filter(d =>
      d.placeLocation && d.startTime && d.endTime
    );

    console.log(`ìœ íš¨í•œ ë°©ë¬¸ ë°ì´í„°: ${visits.length}ê°œ`);

    /* 2ï¸âƒ£ í¬ì¸íŠ¸ ë³€í™˜ (ë©”ëª¨ë¦¬ íš¨ìœ¨ì ìœ¼ë¡œ) */
    const points = [];
    for (let i = 0; i < visits.length; i++) {
      const d = visits[i];
      try {
        const [lat, lng] = d.placeLocation
          .replace('geo:', '')
          .split(',')
          .map(Number);

        if (isNaN(lat) || isNaN(lng)) continue;

        const start = new Date(d.startTime);
        const end = new Date(d.endTime);
        const durationHours = (end - start) / 1000 / 60 / 60;

        points.push({
          lat,
          lng,
          start,
          end,
          durationHours,
          type: d.semanticType || 'Unknown'
        });
      } catch (e) {
        console.warn(`ë°ì´í„° ë³€í™˜ ì‹¤íŒ¨ (ì¸ë±ìŠ¤ ${i}):`, e);
      }

      // ë©”ëª¨ë¦¬ ê´€ë¦¬ë¥¼ ìœ„í•œ ì£¼ê¸°ì  íŒíŠ¸
      if (i % 5000 === 0 && i > 0) {
        console.log(`í¬ì¸íŠ¸ ë³€í™˜ ì¤‘... ${i}/${visits.length} (${((i/visits.length)*100).toFixed(1)}%)`);
      }
    }

    console.log(`ë³€í™˜ëœ í¬ì¸íŠ¸: ${points.length}ê°œ`);
    
    // ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í™•ì¸ (ê°€ëŠ¥í•œ ê²½ìš°)
    if (performance.memory) {
      const memoryMB = (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(2);
      console.log(`í˜„ì¬ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: ${memoryMB} MB`);
    }
    
    // ì›ë³¸ ë°ì´í„° ì°¸ì¡° í•´ì œ
    data.length = 0;
    visits.length = 0;

    return points;
  } catch (error) {
    console.error('ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:', error);
    throw error;
  }
}

loadVisitsData().then(points => {

    /* 3ï¸âƒ£ ì‹œê°„ìˆœ ì •ë ¬ */
    console.log('ì‹œê°„ìˆœ ì •ë ¬ ì¤‘...');
    points.sort((a, b) => a.start - b.start);
    console.log('ì •ë ¬ ì™„ë£Œ');
    
    // ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í™•ì¸
    if (performance.memory) {
      const memoryMB = (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(2);
      console.log(`ì •ë ¬ í›„ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: ${memoryMB} MB`);
    }

    /* 4ï¸âƒ£ ì§€ë„ ì´ˆê¸°í™” */
    const map = new maplibregl.Map({
      container: 'map',
      style: {
        version: 8,
        sources: {
          'raster-tiles': {
            type: 'raster',
            tiles: [
              '/api/tiles/{z}/{x}/{y}.png'  // ì„œë²„ í”„ë¡ì‹œë¥¼ í†µí•´ íƒ€ì¼ ë¡œë“œ (CORS ë¬¸ì œ í•´ê²°, fallback ì§€ì›)
            ],
            tileSize: 256,
            attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
          }
        },
        layers: [
          {
            id: 'simple-tiles',
            type: 'raster',
            source: 'raster-tiles',
            minzoom: 0,
            maxzoom: 19  // OpenStreetMapì€ ìµœëŒ€ 19ê¹Œì§€ë§Œ ì§€ì›
          }
        ]
      },
      center: [points[0].lng, points[0].lat],
      zoom: 13,
      maxZoom: 19  // ì§€ë„ ìµœëŒ€ ì¤Œ ë ˆë²¨ ì œí•œ (CORS ë° 400 ì˜¤ë¥˜ ë°©ì§€)
    });

    // ë„¤ë¹„ê²Œì´ì…˜ ì»¨íŠ¸ë¡¤ ì¶”ê°€
    map.addControl(new maplibregl.NavigationControl(), 'top-right');

    // íƒ€ì¼ ë¡œë”© ì—ëŸ¬ ì²˜ë¦¬
    map.on('error', (e) => {
      console.error('Map error:', e);
      if (e.error && e.error.message) {
        console.error('Error message:', e.error.message);
      }
    });

    // íƒ€ì¼ ì†ŒìŠ¤ ì—ëŸ¬ ì²˜ë¦¬
    map.on('sourcedata', (e) => {
      if (e.isSourceLoaded && e.sourceId === 'raster-tiles') {
        if (e.tile && e.tile.state === 'errored') {
          console.warn('Tile load error for:', e.tile.tileID);
        }
      }
    });

    const slider = document.getElementById('timeline');
    const dateLabel = document.getElementById('dateLabel');
    const locationLabel = document.getElementById('locationLabel');
    const playBtn = document.getElementById('playBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const restartBtn = document.getElementById('restartBtn');
    const speedBtn = document.getElementById('speedBtn');
    const downloadBtn = document.getElementById('downloadBtn');

    slider.max = points.length - 1;

    let timer = null;
    let markers = [];
    let popups = [];
    
    // ì¬ìƒ ì†ë„ ìƒíƒœ (1x, 2x, 4x)
    let playbackSpeed = 1; // ê¸°ë³¸ ì†ë„
    const speedOptions = [1, 2, 4]; // 1ë°°ì†, 2ë°°ì†, 4ë°°ì†
    const baseInterval = 500; // ê¸°ë³¸ ê°„ê²© (ms)

    function getColor(type) {
      if (type.includes('Home')) return '#10b981'; // ì—ë©”ë„ë“œ ê·¸ë¦°
      if (type.includes('Work')) return '#3b82f6'; // ë°ì€ íŒŒë€ìƒ‰
      return '#8b5cf6'; // ë³´ë¼ìƒ‰
    }

    function getColorLight(type) {
      if (type.includes('Home')) return '#34d399'; // ë°ì€ ì—ë©”ë„ë“œ
      if (type.includes('Work')) return '#60a5fa'; // ë°ì€ íŒŒë€ìƒ‰
      return '#a78bfa'; // ë°ì€ ë³´ë¼ìƒ‰
    }

    // ë‘ ì§€ì  ê°„ ê±°ë¦¬ ê³„ì‚° (í•˜ë²„ì‚¬ì¸ ê³µì‹)
    function getDistance(lat1, lng1, lat2, lng2) {
      const R = 6371; // ì§€êµ¬ ë°˜ê²½ (km)
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLng/2) * Math.sin(dLng/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c * 1000; // ë¯¸í„° ë‹¨ìœ„ë¡œ ë°˜í™˜
    }

    // í´ëŸ¬ìŠ¤í„°ë§ í•¨ìˆ˜ (ê°€ê¹Œìš´ ë§ˆì»¤ë“¤ì„ ê·¸ë£¹í™”)
    function clusterMarkers(points, clusterRadius = 50) {
      const clusters = [];
      const used = new Set();
      
      // ì¤Œ ë ˆë²¨ì— ë”°ë¼ í´ëŸ¬ìŠ¤í„° ë°˜ê²½ ì¡°ì • (ìµœì†Œ 5ë¯¸í„° ë³´ì¥)
      const zoom = map ? map.getZoom() : 13;
      const baseAdjustedRadius = clusterRadius * (1 / Math.pow(2, Math.max(0, zoom - 10)));
      const adjustedRadius = Math.max(5, baseAdjustedRadius); // ìµœì†Œ 5ë¯¸í„° ë³´ì¥
      
      // ì¢Œí‘œ ì •ë°€ë„ (ê°™ì€ ì¢Œí‘œë¡œ ê°„ì£¼í•  ìµœì†Œ ì°¨ì´, ë¯¸í„° ë‹¨ìœ„)
      const coordinatePrecision = 0.00001; // ì•½ 1ë¯¸í„°
      
      for (let i = 0; i < points.length; i++) {
        if (used.has(i)) continue;
        
        const cluster = {
          points: [points[i]],
          centerLat: points[i].lat,
          centerLng: points[i].lng,
          indices: [i]
        };
        
        used.add(i);
        
        // ê°€ê¹Œìš´ í¬ì¸íŠ¸ë“¤ì„ í´ëŸ¬ìŠ¤í„°ì— ì¶”ê°€
        for (let j = i + 1; j < points.length; j++) {
          if (used.has(j)) continue;
          
          // ì™„ì „íˆ ê°™ì€ ì¢Œí‘œì¸ì§€ ë¨¼ì € í™•ì¸ (ì„±ëŠ¥ ìµœì í™”)
          const latDiff = Math.abs(points[i].lat - points[j].lat);
          const lngDiff = Math.abs(points[i].lng - points[j].lng);
          
          let shouldCluster = false;
          
          // ì™„ì „íˆ ê°™ì€ ì¢Œí‘œ (ë˜ëŠ” ë§¤ìš° ê°€ê¹Œìš´ ì¢Œí‘œ)
          if (latDiff < coordinatePrecision && lngDiff < coordinatePrecision) {
            shouldCluster = true;
          } else {
            // ê±°ë¦¬ ê¸°ë°˜ í´ëŸ¬ìŠ¤í„°ë§
            const distance = getDistance(
              cluster.centerLat, cluster.centerLng,
              points[j].lat, points[j].lng
            );
            shouldCluster = distance <= adjustedRadius;
          }
          
          if (shouldCluster) {
            cluster.points.push(points[j]);
            cluster.indices.push(j);
            used.add(j);
            
            // í´ëŸ¬ìŠ¤í„° ì¤‘ì‹¬ ì¬ê³„ì‚°
            cluster.centerLat = cluster.points.reduce((sum, p) => sum + p.lat, 0) / cluster.points.length;
            cluster.centerLng = cluster.points.reduce((sum, p) => sum + p.lng, 0) / cluster.points.length;
          }
        }
        
        clusters.push(cluster);
      }
      
      return clusters;
    }

    // ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ìƒì„±
    function createClusterDropdown(cluster, markerElement) {
      // ê¸°ì¡´ ë“œë¡­ë‹¤ìš´ ì œê±°
      const existing = document.querySelector('.cluster-dropdown');
      if (existing) {
        existing.remove();
      }

      const dropdown = document.createElement('div');
      dropdown.className = 'cluster-dropdown';
      
      const header = document.createElement('div');
      header.className = 'cluster-dropdown-header';
      header.innerHTML = `
        <span>ğŸ“ ${cluster.points.length}ê°œ ìœ„ì¹˜</span>
        <button class="cluster-dropdown-close">Ã—</button>
      `;
      
      const content = document.createElement('div');
      content.style.maxHeight = '300px';
      content.style.overflowY = 'auto';
      
      // ì‹œê°„ìˆœ ì •ë ¬
      const sortedPoints = [...cluster.points].sort((a, b) => a.start - b.start);
      
      sortedPoints.forEach((point, idx) => {
        const item = document.createElement('div');
        item.className = 'cluster-dropdown-item';
        const color = getColor(point.type);
        item.innerHTML = `
          <div class="cluster-item-type" style="color: ${color};">${point.type}</div>
          <div class="cluster-item-time">ğŸ• ${point.start.toLocaleString('ko-KR')}</div>
          <div class="cluster-item-duration">â±ï¸ ${point.durationHours.toFixed(1)}ì‹œê°„ | ğŸ“ ${point.lat.toFixed(4)}, ${point.lng.toFixed(4)}</div>
        `;
        
        item.addEventListener('click', () => {
          map.flyTo({
            center: [point.lng, point.lat],
            zoom: Math.max(map.getZoom(), 15),
            duration: 500
          });
          dropdown.classList.remove('show');
        });
        
        content.appendChild(item);
      });
      
      dropdown.appendChild(header);
      dropdown.appendChild(content);
      
      // ë‹«ê¸° ë²„íŠ¼
      header.querySelector('.cluster-dropdown-close').addEventListener('click', () => {
        dropdown.classList.remove('show');
      });
      
      // ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
      document.addEventListener('click', function closeDropdown(e) {
        if (!dropdown.contains(e.target) && !markerElement.contains(e.target)) {
          dropdown.classList.remove('show');
          document.removeEventListener('click', closeDropdown);
        }
      });
      
      document.body.appendChild(dropdown);
      
      // ë§ˆì»¤ ìœ„ì¹˜ ê¸°ì¤€ìœ¼ë¡œ ë“œë¡­ë‹¤ìš´ ìœ„ì¹˜ ì„¤ì •
      const markerRect = markerElement.getBoundingClientRect();
      const mapRect = map.getContainer().getBoundingClientRect();
      
      dropdown.style.position = 'fixed';
      dropdown.style.left = markerRect.left + markerRect.width / 2 - 150 + 'px';
      dropdown.style.top = markerRect.bottom + 10 + 'px';
      
      // í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šë„ë¡ ì¡°ì •
      if (parseInt(dropdown.style.left) < 10) {
        dropdown.style.left = '10px';
      }
      if (parseInt(dropdown.style.left) + 300 > window.innerWidth) {
        dropdown.style.left = (window.innerWidth - 310) + 'px';
      }
      if (parseInt(dropdown.style.top) + 400 > window.innerHeight) {
        dropdown.style.top = (markerRect.top - 410) + 'px';
      }
      
      return dropdown;
    }

    /* 5ï¸âƒ£ ë Œë” í•¨ìˆ˜ (ë©”ëª¨ë¦¬ ìµœì í™”) */
    function render(index, options = {}) {
      const { skipAutoMove = false } = options;
      currentRenderIndex = index;
      // ê¸°ì¡´ ë§ˆì»¤ì™€ íŒì—… ì œê±° (ë©”ëª¨ë¦¬ í•´ì œ)
      markers.forEach(marker => {
        if (marker && marker.remove) {
          marker.remove();
        }
      });
      popups.forEach(popup => {
        if (popup && popup.remove) {
          popup.remove();
        }
      });
      markers.length = 0; // ë°°ì—´ ì´ˆê¸°í™”
      popups.length = 0;

      // í˜„ì¬ ì¸ë±ìŠ¤ê¹Œì§€ì˜ í¬ì¸íŠ¸ë§Œ ì‚¬ìš© (ë©”ëª¨ë¦¬ ì ˆì•½)
      const visible = points.slice(0, index + 1);
      
      // ìµœëŒ€ í‘œì‹œ ë§ˆì»¤ ìˆ˜ ì œí•œ (ì„±ëŠ¥ í–¥ìƒ)
      const MAX_MARKERS = 1000;
      const visibleForMarkers = visible.length > MAX_MARKERS 
        ? visible.slice(-MAX_MARKERS) // ìµœê·¼ Nê°œë§Œ í‘œì‹œ
        : visible;

      // ë‚ ì§œ í‘œì‹œ
      const current = visible[visible.length - 1];
      dateLabel.textContent =
        current.start.toLocaleDateString() + ' ' +
        current.start.toLocaleTimeString();
      
      // ì§€ì—­ëª… í‘œì‹œ
      locationLabel.textContent = current.type;

      // ì´ë™ ê²½ë¡œ ë¼ì¸ ì—…ë°ì´íŠ¸ (ë” ëª…í™•í•˜ê²Œ í‘œì‹œ)
      if (visible.length > 1) {
        const maxPathPoints = 10000; // ê²½ë¡œ í¬ì¸íŠ¸ ìˆ˜ ì¦ê°€
        const pathPoints = visible.length > maxPathPoints 
          ? visible.slice(-maxPathPoints) // ìµœê·¼ Nê°œë§Œ ì‚¬ìš©
          : visible;
        const coordinates = pathPoints.map(p => [p.lng, p.lat]);
        
        // ê¸°ì¡´ ì†ŒìŠ¤ê°€ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ìƒì„±
        if (map.getSource('route')) {
          map.getSource('route').setData({
            type: 'Feature',
            properties: {},
            geometry: {
              type: 'LineString',
              coordinates: coordinates
            }
          });
        } else {
          map.addSource('route', {
            type: 'geojson',
            data: {
              type: 'Feature',
              properties: {},
              geometry: {
                type: 'LineString',
                coordinates: coordinates
              }
            }
          });
        }

        // ë ˆì´ì–´ê°€ ì—†ìœ¼ë©´ ìƒì„±
        if (!map.getLayer('route-line')) {
          // ë°°ê²½ ë¼ì¸ (ë” ë‘ê»ê³  ë°˜íˆ¬ëª…)
          map.addLayer({
            id: 'route-line-bg',
            type: 'line',
            source: 'route',
            layout: {
              'line-join': 'round',
              'line-cap': 'round'
            },
            paint: {
              'line-color': '#ffffff',
              'line-width': 8,
              'line-opacity': 0.4
            }
          });

          // ë©”ì¸ ê²½ë¡œ ë¼ì¸
          map.addLayer({
            id: 'route-line',
            type: 'line',
            source: 'route',
            layout: {
              'line-join': 'round',
              'line-cap': 'round'
            },
            paint: {
              'line-color': '#667eea',
              'line-width': 5,
              'line-opacity': 0.9
            }
          });
        }
      } else {
        // í¬ì¸íŠ¸ê°€ 1ê°œ ì´í•˜ì¼ ë•ŒëŠ” ê²½ë¡œ ë¼ì¸ ì œê±°
        if (map.getLayer('route-line')) {
          map.removeLayer('route-line');
        }
        if (map.getLayer('route-line-bg')) {
          map.removeLayer('route-line-bg');
        }
        if (map.getSource('route')) {
          map.removeSource('route');
        }
      }

      // í´ëŸ¬ìŠ¤í„°ë§ ì ìš©
      const clusters = clusterMarkers(visibleForMarkers, 50); // 50ë¯¸í„° ë°˜ê²½ ë‚´ ë§ˆì»¤ í´ëŸ¬ìŠ¤í„°ë§
      
      clusters.forEach((cluster, clusterIdx) => {
        const isCluster = cluster.points.length > 1;
        const isCurrent = cluster.points.some(p => 
          visibleForMarkers.indexOf(p) === visibleForMarkers.length - 1
        );
        
        if (isCluster) {
          // í´ëŸ¬ìŠ¤í„° ë§ˆì»¤ ìƒì„±
          const el = document.createElement('div');
          el.className = 'cluster-marker';
          const size = Math.min(50, 30 + cluster.points.length * 2);
          el.style.width = size + 'px';
          el.style.height = size + 'px';
          el.style.fontSize = size > 40 ? '16px' : '14px';
          el.textContent = cluster.points.length;
          
          // í´ëŸ¬ìŠ¤í„° ìš”ì•½ ì •ë³´ ìƒì„± (íŒì—…ìš©)
          const sortedPoints = [...cluster.points].sort((a, b) => a.start - b.start);
          const firstPoint = sortedPoints[0];
          const lastPoint = sortedPoints[sortedPoints.length - 1];
          const totalDuration = cluster.points.reduce((sum, p) => sum + p.durationHours, 0);
          const types = [...new Set(cluster.points.map(p => p.type))];
          
          // íŒì—… ìƒì„±
          const popup = new maplibregl.Popup({ 
            offset: 25,
            closeButton: true,
            closeOnClick: false,
            className: 'custom-popup'
          })
            .setHTML(`
              <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; padding: 4px;">
                <div style="margin-bottom: 8px;">
                  <b style="color: #667eea; font-size: 16px; display: block; margin-bottom: 4px;">
                    ğŸ“ í´ëŸ¬ìŠ¤í„° (${cluster.points.length}ê°œ ìœ„ì¹˜)
                  </b>
                  <span style="color: #999; font-size: 11px;">
                    ì¤‘ì‹¬ ìœ„ì¹˜: ${cluster.centerLat.toFixed(6)}, ${cluster.centerLng.toFixed(6)}
                  </span>
                </div>
                <div style="border-top: 1px solid #eee; padding-top: 8px; margin-top: 8px;">
                  <div style="color: #666; font-size: 13px; line-height: 1.6;">
                    <div style="margin-bottom: 4px;">
                      <span style="color: #999;">ğŸ“ ìœ„ì¹˜ ìœ í˜•:</span> 
                      <strong style="color: #333;">${types.join(', ')}</strong>
                    </div>
                    <div style="margin-bottom: 4px;">
                      <span style="color: #999;">â±ï¸ ì´ ì²´ë¥˜ ì‹œê°„:</span> 
                      <strong style="color: #333;">${totalDuration.toFixed(1)}ì‹œê°„</strong>
                    </div>
                    <div style="margin-bottom: 4px;">
                      <span style="color: #999;">ğŸ• ì²« ë°©ë¬¸:</span> 
                      <strong style="color: #333;">${firstPoint.start.toLocaleString('ko-KR')}</strong>
                    </div>
                    <div style="margin-bottom: 4px;">
                      <span style="color: #999;">ğŸ• ë§ˆì§€ë§‰ ë°©ë¬¸:</span> 
                      <strong style="color: #333;">${lastPoint.end.toLocaleString('ko-KR')}</strong>
                    </div>
                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee;">
                      <button id="showClusterDetails" style="
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 12px;
                        font-weight: 600;
                        width: 100%;
                        transition: all 0.2s ease;
                      " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        ğŸ“‹ ìƒì„¸ ëª©ë¡ ë³´ê¸°
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            `);
          
          const marker = new maplibregl.Marker(el)
            .setLngLat([cluster.centerLng, cluster.centerLat])
            .setPopup(popup)
            .addTo(map);
          
          // íŒì—…ì´ ì—´ë¦´ ë•Œ ìƒì„¸ ëª©ë¡ ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€
          marker.on('popupopen', () => {
            const showDetailsBtn = document.getElementById('showClusterDetails');
            if (showDetailsBtn) {
              showDetailsBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                popup.remove(); // íŒì—… ë‹«ê¸°
                const dropdown = createClusterDropdown(cluster, el);
                dropdown.classList.add('show');
              });
            }
          });
          
          // í´ëŸ¬ìŠ¤í„° í´ë¦­ ì‹œ íŒì—… í† ê¸€
          el.addEventListener('click', (e) => {
            e.stopPropagation();
            // íŒì—… í† ê¸€
            if (marker.getPopup().isOpen()) {
              marker.togglePopup();
            } else {
              marker.togglePopup();
            }
          });
          
          markers.push(marker);
          popups.push(popup);
        } else {
          // ë‹¨ì¼ ë§ˆì»¤ (í´ëŸ¬ìŠ¤í„°ë§ë˜ì§€ ì•Šì€ ê²½ìš°)
          const p = cluster.points[0];
          const idx = visibleForMarkers.indexOf(p);
          const isCurrentSingle = idx === visibleForMarkers.length - 1;
          const baseRadius = Math.min(16, 5 + p.durationHours * 1.5);
          const radius = isCurrentSingle ? baseRadius + 2 : baseRadius;
          const color = getColor(p.type);

          const el = document.createElement('div');
          el.className = 'custom-marker';
          el.style.width = radius * 2 + 'px';
          el.style.height = radius * 2 + 'px';
          el.style.borderRadius = '50%';
          el.style.backgroundColor = color;
          el.style.border = `3px solid #ffffff`;
          el.style.boxShadow = isCurrentSingle 
            ? `0 0 0 4px ${color}40, 0 4px 12px rgba(0,0,0,0.3)` 
            : '0 2px 8px rgba(0,0,0,0.2)';
          el.style.cursor = 'pointer';
          el.style.transition = 'all 0.3s ease';

          // íŒì—… ìƒì„±
          const popup = new maplibregl.Popup({ 
            offset: 25,
            closeButton: true,
            closeOnClick: false,
            className: 'custom-popup'
          })
            .setHTML(`
              <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; padding: 4px;">
                <div style="margin-bottom: 8px;">
                  <b style="color: ${color}; font-size: 16px; display: block; margin-bottom: 4px;">${p.type}</b>
                  <span style="color: #999; font-size: 11px;">ìœ„ì¹˜: ${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}</span>
                </div>
                <div style="border-top: 1px solid #eee; padding-top: 8px; margin-top: 8px;">
                  <div style="color: #666; font-size: 13px; line-height: 1.6;">
                    <div style="margin-bottom: 4px;">
                      <span style="color: #999;">â±ï¸ ì²´ë¥˜ ì‹œê°„:</span> 
                      <strong style="color: #333;">${p.durationHours.toFixed(1)}ì‹œê°„</strong>
                    </div>
                    <div style="margin-bottom: 4px;">
                      <span style="color: #999;">ğŸ• ì‹œì‘:</span> 
                      <strong style="color: #333;">${p.start.toLocaleString('ko-KR')}</strong>
                    </div>
                    <div>
                      <span style="color: #999;">ğŸ• ì¢…ë£Œ:</span> 
                      <strong style="color: #333;">${p.end.toLocaleString('ko-KR')}</strong>
                    </div>
                  </div>
                </div>
              </div>
            `);

          const marker = new maplibregl.Marker(el)
            .setLngLat([p.lng, p.lat])
            .setPopup(popup)
            .addTo(map);

          // ë§ˆì»¤ í˜¸ë²„ íš¨ê³¼
          el.addEventListener('mouseenter', () => {
            el.style.transform = 'scale(1.2)';
            el.style.zIndex = '1000';
          });
          
          el.addEventListener('mouseleave', () => {
            el.style.transform = 'scale(1)';
            el.style.zIndex = 'auto';
          });

          markers.push(marker);
          popups.push(popup);
        }
      });

      // ì§€ë„ ì¤‘ì‹¬ ì´ë™ (ì¤Œ ë ˆë²¨ì€ ìœ ì§€, ì‚¬ìš©ìê°€ ì¤Œ ì¡°ì‘ ì¤‘ì´ê±°ë‚˜ skipAutoMoveê°€ trueì¼ ë•ŒëŠ” ìŠ¤í‚µ)
      if (!skipAutoMove && autoMoveEnabled && !isUserZooming) {
        const currentZoom = map.getZoom();
        map.easeTo({
          center: [current.lng, current.lat],
          zoom: currentZoom, // í˜„ì¬ ì¤Œ ë ˆë²¨ ìœ ì§€
          duration: 500
        });
      }
    }

    // í˜„ì¬ ë Œë” ì¸ë±ìŠ¤ ì €ì¥
    let currentRenderIndex = 0;
    let isUserZooming = false; // ì‚¬ìš©ìê°€ ì¤Œ ì¡°ì‘ ì¤‘ì¸ì§€ ì—¬ë¶€
    let autoMoveEnabled = true; // ìë™ ì´ë™ í™œì„±í™” ì—¬ë¶€

    // ì§€ë„ ë¡œë“œ í›„ ì´ˆê¸° ë Œë”ë§
    map.on('load', () => {
      render(0);
      currentRenderIndex = 0;
    });

    // ì‚¬ìš©ìê°€ ì¤Œ ì‹œì‘í•  ë•Œ
    map.on('zoomstart', () => {
      isUserZooming = true;
    });

    // ì‚¬ìš©ìê°€ ì¤Œ ì¢…ë£Œí•  ë•Œ
    map.on('zoomend', () => {
      if (isUserZooming) {
        // ì‚¬ìš©ìê°€ ì¤Œì„ ì¡°ì‘í•œ ê²½ìš°, í´ëŸ¬ìŠ¤í„°ë§ë§Œ ì¬ê³„ì‚°í•˜ê³  ìë™ ì´ë™ì€ í•˜ì§€ ì•ŠìŒ
        isUserZooming = false;
        render(currentRenderIndex, { skipAutoMove: true });
      }
    });

    // ì§€ë„ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
    map.on('click', () => {
      const dropdown = document.querySelector('.cluster-dropdown');
      if (dropdown) {
        dropdown.classList.remove('show');
      }
    });

    /* ìŠ¬ë¼ì´ë” - ì‚¬ìš©ì ì¡°ì‘ ë¹„í™œì„±í™” */
    // slider.addEventListener('input', e => {
    //   render(Number(e.target.value));
    // });

    /* â© ë¹¨ë¦¬ê°ê¸° í† ê¸€ */
    speedBtn.addEventListener('click', () => {
      // í˜„ì¬ ì†ë„ ì¸ë±ìŠ¤ ì°¾ê¸°
      const currentIndex = speedOptions.indexOf(playbackSpeed);
      // ë‹¤ìŒ ì†ë„ë¡œ ë³€ê²½ (ìˆœí™˜)
      const nextIndex = (currentIndex + 1) % speedOptions.length;
      playbackSpeed = speedOptions[nextIndex];
      
      // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
      speedBtn.textContent = playbackSpeed === 1 ? 'â© 1x' : playbackSpeed === 2 ? 'â©â© 2x' : 'â©â©â© 4x';
      
      // í™œì„± ìƒíƒœ í‘œì‹œ
      if (playbackSpeed > 1) {
        speedBtn.classList.add('active');
      } else {
        speedBtn.classList.remove('active');
      }
      
      // ì¬ìƒ ì¤‘ì´ë©´ íƒ€ì´ë¨¸ ì¬ì‹œì‘
      if (timer) {
        clearInterval(timer);
        timer = null;
        // ì¬ìƒ ì¬ì‹œì‘
        playBtn.click();
      }
    });

    /* â–¶ ì¬ìƒ (ë©”ëª¨ë¦¬ ìµœì í™”) */
    playBtn.addEventListener('click', () => {
      if (timer) return;

      playBtn.style.display = 'none';
      pauseBtn.style.display = 'inline-block';

      let frameCount = 0;
      const currentInterval = baseInterval / playbackSpeed; // ì¬ìƒ ì†ë„ì— ë”°ë¼ ê°„ê²© ì¡°ì •
      
      timer = setInterval(() => {
        let v = Number(slider.value);
        if (v >= slider.max) {
          clearInterval(timer);
          timer = null;
          playBtn.style.display = 'inline-block';
          pauseBtn.style.display = 'none';
          return;
        }
        
        // ì¬ìƒ ì†ë„ì— ë”°ë¼ ì—¬ëŸ¬ í”„ë ˆì„ ê±´ë„ˆë›°ê¸°
        const step = playbackSpeed;
        slider.value = Math.min(v + step, slider.max);
        render(Number(slider.value));
        
        // ì£¼ê¸°ì ìœ¼ë¡œ ë©”ëª¨ë¦¬ ì •ë¦¬ íŒíŠ¸ (ë§¤ 50í”„ë ˆì„ë§ˆë‹¤)
        frameCount++;
        if (frameCount % 50 === 0) {
          // ë¸Œë¼ìš°ì €ì—ê²Œ ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ íŒíŠ¸ ì œê³µ
          if (window.gc) {
            window.gc();
          }
        }
      }, currentInterval);
    });

    /* â¸ ì •ì§€ */
    pauseBtn.addEventListener('click', () => {
      clearInterval(timer);
      timer = null;
      playBtn.style.display = 'inline-block';
      pauseBtn.style.display = 'none';
    });

    /* â® ë‹¤ì‹œ ì¬ìƒ */
    restartBtn.addEventListener('click', () => {
      clearInterval(timer);
      timer = null;
      playBtn.style.display = 'inline-block';
      pauseBtn.style.display = 'none';
      slider.value = 0;
      render(0);
    });

    /* ğŸ’¾ ë‹¤ìš´ë¡œë“œ */
    downloadBtn.addEventListener('click', () => {
      window.location.href = '/api/download';
    });

    /* ë²”ë¡€ */
    const legend = document.createElement('div');
    legend.className = 'legend';
    legend.innerHTML = `
      <b style="color: #333; margin-bottom: 4px; display: block;">ë°©ë¬¸ ìœ í˜•</b>
      <span style="color:#10b981; font-size: 16px;">â—</span> <span style="color: #555;">Home</span><br/>
      <span style="color:#3b82f6; font-size: 16px;">â—</span> <span style="color: #555;">Work</span><br/>
      <span style="color:#8b5cf6; font-size: 16px;">â—</span> <span style="color: #555;">Other</span>
    `;
    legend.style.position = 'absolute';
    legend.style.bottom = '20px';
    legend.style.right = '20px';
    legend.style.zIndex = '1000';
    document.body.appendChild(legend);
  }).catch(error => {
    console.error('ë°ì´í„° ì²˜ë¦¬ ì˜¤ë¥˜:', error);
    alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
  });
</script>

</body>
</html>
